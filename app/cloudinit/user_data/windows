<powershell>
$ProgressPreference = 'SilentlyContinue'
echo "[DRONE] Initialization Starting"

if (${{ .IsHosted }} -eq $false) {
	echo "[DRONE] Installing Scoop Package Manager"
	iex "& {$(irm https://get.scoop.sh)} -RunAsAdmin"

	echo "[DRONE] Installing Git"
	scoop install git --global

	echo "[DRONE] Updating PATH so we have access to git commands (otherwise Scoop.sh shim files cannot be found)"
	$env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
}

echo "[DRONE] Setup LiteEngine Certificates"

mkdir "C:\Program Files\lite-engine"
mkdir "{{ .CertDir }}"

$object0 = "{{ .CACert | base64 }}"
$Object = [System.Convert]::FromBase64String($object0)
[system.io.file]::WriteAllBytes("{{ .CaCertPath }}",$object)

$object1 = "{{ .TLSCert | base64 }}"
$Object = [System.Convert]::FromBase64String($object1)
[system.io.file]::WriteAllBytes("{{ .CertPath }}",$object)

$object2 = "{{ .TLSKey | base64 }}"
$Object = [System.Convert]::FromBase64String($object2)
[system.io.file]::WriteAllBytes("{{ .KeyPath }}",$object)

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 -bor [Net.SecurityProtocolType]::Tls11 -bor [Net.SecurityProtocolType]::Tls

$primaryPluginUrl = "{{ .PluginBinaryURI }}/plugin-{{ .Platform.OS }}-{{ .Platform.Arch }}.exe"
$secondaryPluginUrl = "{{ .PluginBinaryFallbackURI }}/plugin-{{ .Platform.OS }}-{{ .Platform.Arch }}.exe"
$outputFile = "C:\Program Files\lite-engine\plugin.exe"

try {
    echo "[DRONE] Downloading plugin from primary URL"
    Invoke-WebRequest -Uri $primaryPluginUrl -OutFile $outputFile
} catch {
    echo "[DRONE] Primary URL failed for plugin, attempting to download from secondary URL"
    Invoke-WebRequest -Uri $secondaryPluginUrl -OutFile $outputFile
}

$env:Path = 'C:\Program Files\lite-engine;' + $env:Path

# Refresh the PSEnviroment
refreshenv

fsutil file createnew "C:\Program Files\lite-engine\.env" 0
echo "CLOUD_DRIVER={{ .DriverName }}" >> "C:\Program Files\lite-engine\.env"

{{ if .AnnotationsBinaryURI }}
# Create shared volume directory (lite-engine uses c:\tmp\engine for Windows)
echo "[DRONE][ANNOTATIONS] Starting annotations CLI setup for Windows"
echo "[DRONE][ANNOTATIONS] Platform: {{ .Platform.OS }}-{{ .Platform.Arch }}"
echo "[DRONE][ANNOTATIONS] Creating shared volume directory: c:\tmp\engine"

try {
    New-Item -ItemType Directory -Force -Path "c:\tmp\engine" | Out-Null
    echo "[DRONE][ANNOTATIONS] Successfully created directory: c:\tmp\engine"
} catch {
    echo "[DRONE][ANNOTATIONS][ERROR] Failed to create directory c:\tmp\engine: $_"
    echo "[DRONE][ANNOTATIONS][ERROR] This will cause annotations to fail!"
}

# Verify directory exists
if (Test-Path "c:\tmp\engine") {
    echo "[DRONE][ANNOTATIONS] Verified: c:\tmp\engine exists"
} else {
    echo "[DRONE][ANNOTATIONS][ERROR] Directory c:\tmp\engine does NOT exist after creation!"
}

$primaryAnnotationsUrl = "{{ .AnnotationsBinaryURI }}hcli-{{ .Platform.OS }}-{{ .Platform.Arch }}.exe"
$secondaryAnnotationsUrl = "{{ .AnnotationsBinaryFallbackURI }}hcli-{{ .Platform.OS }}-{{ .Platform.Arch }}.exe"
$outputFile = "c:\tmp\engine\hcli.exe"

echo "[DRONE][ANNOTATIONS] Primary URL: $primaryAnnotationsUrl"
echo "[DRONE][ANNOTATIONS] Fallback URL: $secondaryAnnotationsUrl"
echo "[DRONE][ANNOTATIONS] Target file: $outputFile"

try {
    echo "[DRONE][ANNOTATIONS] Attempting download from primary URL..."
    $ProgressPreference = 'SilentlyContinue'
    Invoke-WebRequest -Uri $primaryAnnotationsUrl -OutFile $outputFile -ErrorAction Stop
    echo "[DRONE][ANNOTATIONS] Successfully downloaded from primary URL"
} catch {
    echo "[DRONE][ANNOTATIONS][WARN] Primary URL failed: $_"
    echo "[DRONE][ANNOTATIONS] Attempting download from fallback URL..."
    try {
        Invoke-WebRequest -Uri $secondaryAnnotationsUrl -OutFile $outputFile -ErrorAction Stop
        echo "[DRONE][ANNOTATIONS] Successfully downloaded from fallback URL"
    } catch {
        echo "[DRONE][ANNOTATIONS][ERROR] Both URLs failed! Error: $_"
        echo "[DRONE][ANNOTATIONS][ERROR] Annotations will NOT work!"
    }
}

# Verify binary exists and get details
if (Test-Path $outputFile) {
    $fileInfo = Get-Item $outputFile
    echo "[DRONE][ANNOTATIONS] SUCCESS: hcli binary downloaded"
    echo "[DRONE][ANNOTATIONS] File path: $($fileInfo.FullName)"
    echo "[DRONE][ANNOTATIONS] File size: $($fileInfo.Length) bytes"
    echo "[DRONE][ANNOTATIONS] Last modified: $($fileInfo.LastWriteTime)"
    
    # Test if binary is executable
    try {
        $testOutput = & $outputFile --version 2>&1
        echo "[DRONE][ANNOTATIONS] Binary test: $testOutput"
    } catch {
        echo "[DRONE][ANNOTATIONS][WARN] Could not execute binary (this may be OK if binary requires args): $_"
    }
} else {
    echo "[DRONE][ANNOTATIONS][ERROR] CRITICAL: hcli.exe does NOT exist at $outputFile"
    echo "[DRONE][ANNOTATIONS][ERROR] Annotations WILL FAIL!"
}

echo "[DRONE][ANNOTATIONS] CloudInit annotations setup complete"
{{ end }}

$primaryLiteEngineUrl = "{{ .LiteEnginePath }}/lite-engine-{{ .Platform.OS }}-{{ .Platform.Arch }}.exe"
$secondaryLiteEngineUrl = "{{ .LiteEngineFallbackPath }}/lite-engine-{{ .Platform.OS }}-{{ .Platform.Arch }}.exe"
$outputFile = "C:\Program Files\lite-engine\lite-engine.exe"

try {
    echo "[DRONE] Downloading lite engine from primary URL"
    Invoke-WebRequest -Uri $primaryLiteEngineUrl -OutFile $outputFile
} catch {
    echo "[DRONE] Primary URL failed for lite engine, attempting to download from secondary URL"
    Invoke-WebRequest -Uri $secondaryLiteEngineUrl -OutFile $outputFile
}

New-NetFirewallRule -DisplayName "ALLOW TCP PORT 9079" -Direction inbound -Profile Any -Action Allow -LocalPort 9079 -Protocol TCP
Start-Process -FilePath "C:\Program Files\lite-engine\lite-engine.exe" -ArgumentList "server --env-file=`"C:\Program Files\lite-engine\.env`"" -RedirectStandardOutput "{{ .LiteEngineLogsPath }}" -RedirectStandardError "C:\Program Files\lite-engine\log.err"

if (${{ .IsHosted }} -eq $true) {
	netsh interface ipv4 add dnsserver "Ethernet" 8.8.8.8 index=1
	netsh interface ipv4 add dnsserver "Ethernet" 1.1.1.1 index=2
	netsh interface ipv4 add dnsserver "Ethernet" 8.8.4.4 index=3
	ipconfig /flushdns
	Write-Host "DNS server added to Ethernet interface."
} 
echo "[DRONE] Initialization Complete"

</powershell>